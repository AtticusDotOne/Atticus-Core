<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xmlns:ext="http://www.liquibase.org/xml/ns/dbchangelog-ext"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.0.xsd
        http://www.liquibase.org/xml/ns/dbchangelog-ext http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-ext.xsd">
<changeSet id="user_acc_create_tables-DDL" author="vgorin">
    <sql>
        CREATE TABLE user_role(
            id            TINYINT UNSIGNED NOT NULL PRIMARY KEY,
            name          VARCHAR(16) NOT NULL
        );
        CREATE TABLE country (
            code          CHAR(2) NOT NULL PRIMARY KEY,
            name          VARCHAR(128) NOT NULL
        );
        CREATE TABLE language (
            code          CHAR(3) NOT NULL PRIMARY KEY,
            name          VARCHAR(128) NOT NULL
        );
        CREATE TABLE timezone (
            tz            VARCHAR(64) NOT NULL PRIMARY KEY,
            offset        INTEGER NOT NULL,
            name          VARCHAR(128) NOT NULL
        );
        CREATE TABLE user_acc (
            id            INT UNSIGNED NOT NULL AUTO_INCREMENT PRIMARY KEY,
            role_id       TINYINT UNSIGNED NOT NULL DEFAULT 1,
            email         VARCHAR(64) NOT NULL UNIQUE KEY,
            username      VARCHAR(16) UNIQUE KEY,
            password      BINARY(64) NOT NULL,
            legal_name    VARCHAR(256),
            language_code CHAR(3),
            country_code  CHAR(2),
            timezone_tz   VARCHAR(64),
            deleted       DATETIME, -- null value means account is active

            rec_created   TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
            rec_updated   TIMESTAMP NULL ON UPDATE CURRENT_TIMESTAMP,

            FOREIGN KEY FK_user_account_language_code(language_code) REFERENCES language(code),
            FOREIGN KEY FK_user_account_country_code(country_code) REFERENCES country(code),
            FOREIGN KEY FK_user_account_timezone_tz(timezone_tz) REFERENCES timezone(tz),
            FOREIGN KEY FK_user_account_role_id(role_id) REFERENCES user_role(id)
        );
    </sql>
</changeSet>
<changeSet id="user_acc_create_views" author="vgorin">
    <sql>
        CREATE VIEW user_account (
            id,
            role,
            email,
            username,
            password,
            legal_name,
            language,
            country,
            timezone,
            created,
            updated,
            deleted
        ) AS
        SELECT
            a.id,
            r.name,
            a.email,
            a.username,
            a.password,
            a.legal_name,
            l.name,
            c.name,
            t.name,
            a.rec_created,
            a.rec_updated,
            a.deleted
        FROM user_acc a
        LEFT JOIN user_role r
            ON a.role_id = r.id
        LEFT JOIN language l
            ON a.language_code = l.code
        LEFT JOIN country c
            ON a.country_code = c.code
        LEFT JOIN timezone t
            ON a.timezone_tz = t.tz;
    </sql>
</changeSet>
<changeSet id="user_acc_fill_data-DML" author="vgorin">
    <sql>
        -- define some user roles
        INSERT INTO user_role(id, name) VALUES(1, 'user');
        INSERT INTO user_role(id, name) VALUES(255, 'admin');

        -- TODO: insert more countries
        INSERT INTO country(code, name)
            VALUES('US', 'United States');

        -- TODO: insert more languages
        INSERT INTO language(code, name)
            VALUES('eng', 'English');

        -- TODO: insert all timezones
        INSERT INTO timezone(tz, offset, name)
            VALUES('America/Los_Angeles', -28800000, 'Pacific Standard Time');

        -- insert test users
        INSERT INTO user_acc(email, username, password, legal_name, language_code, country_code, timezone_tz)
            VALUES('1', '1', 0xD207812475E4A5D240311ACE8C8CE0FBFAC068F5F66A4BCE61C80F410D1B89A5B9DB923A64214C3B54EF297D1F9677CFFB618E364B3CADEE1C429B0BFC03EB39, 'One', 'eng', 'US', 'America/Los_Angeles');
        INSERT INTO user_acc(email, username, password, legal_name, language_code, country_code, timezone_tz)
            VALUES('2', '2', 0x88DC6AE462EFA901B3EE2A01608B603D8B22B1A4A99C80E3186FF8F98B660DEF032A97E41A6A66E1D3D5E137464F8C9B8CE2B0D542D785A53410AD4916A34862, 'Two', 'eng', 'US', 'America/Los_Angeles');
        INSERT INTO user_acc(email, username, password, legal_name, language_code, country_code, timezone_tz)
            VALUES('3', '3', 0x5AEE418ECE5D3AF090289470D4E217173C89566A4FA871E8E50FB588BFCBFA4DBAFA6AA1D3DFB33A98136DFC865BCAD994585593A2FA248C76126ACA4909518B, 'Three', 'eng', 'US', 'America/Los_Angeles');
        INSERT INTO user_acc(email, username, password, legal_name, language_code, country_code, timezone_tz)
            VALUES('4', '4', 0xA7825BA5CE78D340C0CEBC54927F2B6ED3CBE9A5DE5ADD421A1E93CFDBAA2DC0FDA1CCB82F6663C19B183362B192834B6B298507A49FB3B0D06DD427EE7C47BD, 'Four', 'eng', 'US', 'America/Los_Angeles');
        INSERT INTO user_acc(email, username, password, legal_name, language_code, country_code, timezone_tz)
            VALUES('5', '5', 0x19D7E05D1E14AAF1F906B58CCB503163EF198A3443DCED52A1BC34F27FF513D7C090BBCA0F13C408B5E9313FB2A21B45272E5C97BBAECECEF1DB5666517F1B44, 'Five', 'eng', 'US', 'America/Los_Angeles');
        INSERT INTO user_acc(email, username, password, legal_name, language_code, country_code, timezone_tz)
            VALUES('sam@atticus.info', 'SamREye', 0xED15D120D9E64E35BBE9E038407F1A8A7FE138E46FD1417ED3EC1D99EFB639683218DB0BB34D6C5B2ADFD6D1D8B08C590001FD9142E042BB629694649316A2CD, 'Samuel Bourque', 'eng', 'US', 'America/Los_Angeles');
        INSERT INTO user_acc(email, username, password, legal_name, language_code, country_code, timezone_tz)
            VALUES('troy@atticus.info', 'TroyMartz', 0xA045452CFF23029B87734613310A14758A568834E1BF7D8D00F1DEC41E1E39437ADDC92E31639ADD430C173A0A6C9D5C7ECECED58F6841FFBFE0763AC472B5E2, 'Troy Martz', 'eng', 'US', 'America/Los_Angeles');

        -- insert admin account
        INSERT INTO user_acc(role_id, email, username, password, language_code, country_code, timezone_tz)
            VALUES(255, 'admin@atticus.com', 'admin', 0x457DCC63CA48F642E567919F67BF53BF2F01B982978CFE3B39522ED25B84A2E1ABDB800855DA3B5F74228EA05A81593BDA9529A9105EAC691C9F7ACC55C3CF74, 'eng', 'US', 'America/Los_Angeles');
    </sql>
</changeSet>

<changeSet id="contract_create_tables-DDL" author="vgorin">
    <sql>
        -- contract template contains text with placeholders
        -- parties are not defined, placeholders' values too
        CREATE TABLE contract_template(
            id          INT UNSIGNED NOT NULL AUTO_INCREMENT PRIMARY KEY,
            account_id  INT UNSIGNED NOT NULL, -- owner/creator of the template
            title       VARCHAR(128) NOT NULL,
            version     VARCHAR(16),
            body        TEXT,
            -- initially template is editable (versioned on date is null)
            -- non-null value means template is not editable anymore
            -- template cannot go back to editable state once this date is set
            versioned   DATETIME, -- null value means template is editable
            deleted     DATETIME, -- null value means template is active
            published   DATETIME, -- null value means template is private
            modified    DATETIME NOT NULL DEFAULT NOW(),

            rec_created TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
            rec_updated TIMESTAMP NULL ON UPDATE CURRENT_TIMESTAMP,

            CONSTRAINT  UQ_contract_template_COV UNIQUE(account_id, title, version),

            FOREIGN KEY FK_contract_template_account_id(account_id) REFERENCES user_acc(id)
        );
        -- contract / draft is a template with the placeholders defined
        CREATE TABLE contract(
            id          INT UNSIGNED NOT NULL AUTO_INCREMENT PRIMARY KEY,
            account_id  INT UNSIGNED NOT NULL, -- draft owner/creator
            template_id INT UNSIGNED, -- null value means contract is not based on the template
            memo        VARCHAR(128) NOT NULL, -- draft name not to be confused with template title
            body        TEXT, -- may contain placeholders as well
            -- initially contract is a draft and its editable (proposed on date is null)
            -- non-null value means contract is not a draft but a proposed contract
            -- contract cannot go back to draft state once it becomes a proposed contract
            -- contract variables cannot be modified for already proposed contracts
            proposed    DATETIME, -- null value means contract is a draft
            deleted     DATETIME, -- null value means contract is active
            modified    DATETIME NOT NULL DEFAULT NOW(),

            rec_created TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
            rec_updated TIMESTAMP NULL ON UPDATE CURRENT_TIMESTAMP,

            FOREIGN KEY FK_contract_account_id(account_id) REFERENCES user_acc(id),
            FOREIGN KEY FK_contract_template_id(template_id) REFERENCES contract_template(id)
        );
        -- one to many mapping between contract and its variables/placeholders values
        CREATE TABLE contract_variable(
            contract_id INT UNSIGNED NOT NULL,
            name        VARCHAR(16) NOT NULL, -- variable/placeholder name
            value       VARCHAR(64) NOT NULL, -- variable/placeholder value

            rec_created TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
            rec_updated TIMESTAMP NULL ON UPDATE CURRENT_TIMESTAMP,

            CONSTRAINT  UQ_contract_variable_COV UNIQUE(contract_id, name),

            FOREIGN KEY FK_contract_variable_contract_id(contract_id) REFERENCES contract(id)
        );
        -- a dialog between parties to sign the contract
        CREATE TABLE deal(
            id          INT UNSIGNED NOT NULL AUTO_INCREMENT PRIMARY KEY,
            account_id  INT UNSIGNED NOT NULL, -- account which initiated the deal
            title       VARCHAR(128),
            deleted     DATETIME, -- null value means deals is active

            rec_created TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
            rec_updated TIMESTAMP NULL ON UPDATE CURRENT_TIMESTAMP,

            CONSTRAINT  UQ_deal_COV UNIQUE(account_id, title),

            FOREIGN KEY FK_deal_account_id(account_id) REFERENCES user_acc(id)
        );
        -- contract proposals, messages and everything else related to a deal
        -- append-only table
        CREATE TABLE deal_dialog(
            id          INT UNSIGNED NOT NULL AUTO_INCREMENT PRIMARY KEY,
            deal_id     INT UNSIGNED NOT NULL,
            account_id  INT UNSIGNED NOT NULL, -- the person who sends a message
            seq_num     INT UNSIGNED NOT NULL, -- message sequence number within dialog
            message     TEXT,
            attachment  BLOB,
            -- first message (seq_num = 0) must contain an initial proposal
            -- following messages (seq_num > 0) may contain counter proposals
            contract_id INT UNSIGNED,

            rec_created TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
            rec_updated TIMESTAMP NULL ON UPDATE CURRENT_TIMESTAMP, -- probably won't be used (messages are non-editable)

            CONSTRAINT  UQ_deal_dialog_COV UNIQUE(deal_id, seq_num),

            FOREIGN KEY FK_deal_dialog_deal_id(deal_id) REFERENCES deal(id),
            FOREIGN KEY FK_deal_dialog_account_id(account_id) REFERENCES user_acc(id),
            FOREIGN KEY FK_deal_dialog_contract_id(contract_id) REFERENCES contract(id)
        );
        -- one to many mapping between contract and parties
        -- unsigned, not expired records are active contract proposals
        CREATE TABLE contract_party(
            id          INT UNSIGNED NOT NULL AUTO_INCREMENT PRIMARY KEY,
            contract_id INT UNSIGNED NOT NULL,
            account_id  INT UNSIGNED NOT NULL,
            party_label VARCHAR(16), -- party label as it is in contract template
            valid_until DATETIME NOT NULL,
            signature   BINARY(132),
            signed_on   DATETIME,

            rec_created TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
            rec_updated TIMESTAMP NULL ON UPDATE CURRENT_TIMESTAMP,

            CONSTRAINT  UQ_contract_party_COV UNIQUE(contract_id, account_id),

            FOREIGN KEY FK_contract_party_contract_id(contract_id) REFERENCES contract(id),
            FOREIGN KEY FK_contract_party_user_account_id(account_id) REFERENCES user_acc(id)
        );
    </sql>
</changeSet>
<changeSet id="contract_fill_data-DML" author="vgorin">
    <sql>

-- insert few contract templates
INSERT INTO contract_template(account_id, title, body)
VALUES(1, 'Consultant Agreement',
'{{parties.client.name}} (information)

(“Client”) engages

{{parties.vendor.name}} (“vendor”) (collectively “Parties”) for technology consulting services.

The intent captured within this memorandum (”Amendment”) is to amend the existing signed agreement between parties signed on {{contract.date_signed}}(Agreement).');
INSERT INTO contract_template(account_id, title, body)
VALUES(1, 'Software Dev Agreement',
'{{parties.client.name}} (information)

(“Client”) engages

{{parties.vendor.name}} (“vendor”) (collectively “Parties”) for technology consulting services.

The intent captured within this memorandum (”Amendment”) is to amend the existing signed agreement between parties signed on {{contract.date_signed}}(Agreement).');
INSERT INTO contract_template(account_id, title, body)
VALUES(1, 'Rental Agreement',
'{{parties.client.name}} (information)

(“Client”) engages

{{parties.vendor.name}} (“vendor”) (collectively “Parties”) for technology consulting services.

The intent captured within this memorandum (”Amendment”) is to amend the existing signed agreement between parties signed on {{contract.date_signed}}(Agreement).');


-- insert few contract drafts
INSERT INTO contract(account_id, memo, body)
VALUES(1, 'Consultant Agreement',
'{{parties.client.name}} (information)

(“Client”) engages

{{parties.vendor.name}} (“vendor”) (collectively “Parties”) for technology consulting services.

The intent captured within this memorandum (”Amendment”) is to amend the existing signed agreement between parties signed on {{contract.date_signed}}(Agreement).');
INSERT INTO contract(account_id, memo, body)
VALUES(1, 'Software Dev Agreement',
'{{parties.client.name}} (information)

(“Client”) engages

{{parties.vendor.name}} (“vendor”) (collectively “Parties”) for technology consulting services.

The intent captured within this memorandum (”Amendment”) is to amend the existing signed agreement between parties signed on {{contract.date_signed}}(Agreement).');
INSERT INTO contract(account_id, memo, body)
VALUES(1, 'Rental Agreement',
'{{parties.client.name}} (information)

(“Client”) engages

{{parties.vendor.name}} (“vendor”) (collectively “Parties”) for technology consulting services.

The intent captured within this memorandum (”Amendment”) is to amend the existing signed agreement between parties signed on {{contract.date_signed}}(Agreement).');

    </sql>
</changeSet>
<!--
<changeSet id="contract_create_procedures-TCL" author="vgorin">
    <sql>

    </sql>
</changeSet>
-->
</databaseChangeLog>
