<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xmlns:ext="http://www.liquibase.org/xml/ns/dbchangelog-ext"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.0.xsd
        http://www.liquibase.org/xml/ns/dbchangelog-ext http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-ext.xsd">
<changeSet id="user_acc_create_tables-DDL" author="vgorin">
    <sql>
        CREATE TABLE country (
            code          CHAR(2) NOT NULL PRIMARY KEY,
            name          VARCHAR(128) NOT NULL
        );
        CREATE TABLE language (
            code          CHAR(3) NOT NULL PRIMARY KEY,
            name          VARCHAR(128) NOT NULL
        );
        CREATE TABLE timezone (
            tz            VARCHAR(64) NOT NULL PRIMARY KEY,
            offset        INTEGER NOT NULL,
            name          VARCHAR(128) NOT NULL
        );
        CREATE TABLE user_acc (
            id            INT NOT NULL AUTO_INCREMENT PRIMARY KEY,
            email         VARCHAR(64) NOT NULL UNIQUE KEY,
            username      VARCHAR(16) UNIQUE KEY,
            password      BINARY(64) NOT NULL,
            legal_name    VARCHAR(256),
            language_code CHAR(3),
            country_code  CHAR(2),
            timezone_tz   VARCHAR(64),

            created       TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
            updated       TIMESTAMP NULL ON UPDATE CURRENT_TIMESTAMP,

            FOREIGN KEY FK_user_account_language_code(language_code) REFERENCES language(code),
            FOREIGN KEY FK_user_account_country_code(country_code) REFERENCES country(code),
            FOREIGN KEY FK_user_account_timezone_tz(timezone_tz) REFERENCES timezone(tz)
        );
    </sql>
</changeSet>
<changeSet id="user_acc_create_views" author="vgorin">
    <sql>
        CREATE VIEW user_account (
            id,
            email,
            username,
            password,
            legal_name,
            language,
            country,
            timezone
        ) AS
        SELECT
            a.id,
            a.email,
            a.username,
            a.password,
            a.legal_name,
            l.name,
            c.name,
            t.name
        FROM user_acc a
        LEFT JOIN language l
            ON a.language_code = l.code
        LEFT JOIN country c
            ON a.country_code = c.code
        LEFT JOIN timezone t
            ON a.timezone_tz = t.tz;
    </sql>
</changeSet>
<changeSet id="user_acc_fill_data-DML" author="vgorin">
    <sql>
        -- TODO: insert more countries
        INSERT INTO country(code, name)
            VALUES('US', 'United States');

        -- TODO: insert more languages
        INSERT INTO language(code, name)
            VALUES('eng', 'English');

        -- TODO: insert all timezones
        INSERT INTO timezone(tz, offset, name)
            VALUES('America/Los_Angeles', -28800000, 'Pacific Standard Time');
    </sql>
</changeSet>

<changeSet id="contract_create_tables-DDL" author="vgorin">
    <sql>
        -- contracts, templates, drafts
        CREATE TABLE contract(
            id          INT NOT NULL AUTO_INCREMENT PRIMARY KEY,
            account_id  INT NOT NULL, -- contract/template/draft owner
            header      VARCHAR(128) NOT NULL,
            body        TEXT NOT NULL,
            parties     TINYINT NOT NULL,
            draft       BIT NOT NULL DEFAULT 1, -- 1 indicates contract is editable and cannot be proposed

            created     TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
            updated     TIMESTAMP NULL ON UPDATE CURRENT_TIMESTAMP,

            FOREIGN KEY FK_contract_template_account_id(account_id) REFERENCES user_acc(id)
        );
        -- list of publicly listed contracts
        CREATE TABLE public_posting(
            contract_id INT NOT NULL,
            active      BIT NOT NULL DEFAULT 1, -- 1 indicates contract is posted

            created     TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
            updated     TIMESTAMP NULL ON UPDATE CURRENT_TIMESTAMP,

            FOREIGN KEY FK_public_posting_contract_id(contract_id) REFERENCES contract(id)
        );
        -- contract proposals
        CREATE TABLE contract_proposal(
            contract_id INT NOT NULL,
            account_id  INT NOT NULL,
            party_index INT NOT NULL, -- [0, contract.parties)
            valid_until DATETIME NOT NULL,

            created     TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
            updated     TIMESTAMP NULL ON UPDATE CURRENT_TIMESTAMP,

            FOREIGN KEY FK_contract_proposal_contract_id(contract_id) REFERENCES contract(id),
            FOREIGN KEY FK_contract_proposal_user_account_id(account_id) REFERENCES user_acc(id)
        );
        -- parties involved in the contract
        CREATE TABLE contract_party(
            contract_id INT NOT NULL,
            account_id  INT NOT NULL,
            party_index INT NOT NULL, -- [0, contract.parties)
            signature   BINARY(132),

            created     TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
            updated     TIMESTAMP NULL ON UPDATE CURRENT_TIMESTAMP,

            FOREIGN KEY FK_contract_party_contract_id(contract_id) REFERENCES contract(id),
            FOREIGN KEY FK_contract_party_user_account_id(account_id) REFERENCES user_acc(id)
        );
    </sql>
</changeSet>
</databaseChangeLog>
